blueprint:
  name: üí° Podbitka ‚Äì Automatyczne ≈õwiat≈Ça (pe≈Çny cykl dobowy)
  description: >
    Kompleksowa automatyzacja o≈õwietlenia zewnƒôtrznego:
    - Wieczorem zapala podbitkƒô (rogi + ≈õrodki), gasi etapami o ustalonych godzinach.
    - Rano ponownie zapala podbitkƒô, je≈õli jeszcze ciemno.
    - Reaguje na otwarcie bramy i drzwi (osobne czasy ≈õwiecenia).
    - Automatycznie blokuje reakcje dzienne.
    - Tryb ‚Äû≈öwiƒôta‚Äù dezaktywuje automatyzacje podbitki.
    - Wszystkie czasy i encje konfigurowalne z GUI.

  domain: automation
  source_url: "https://raw.githubusercontent.com/GieOeRZet/HA_BLUEPRINTS/main/blueprints/automation/gieoerzet/swiatla_zewnetrzne.yaml"

  input:
    czujnik_dnia:
      name: üåÖ Sensor okresu dnia
      description: Sensor okre≈õlajƒÖcy porƒô dnia (np. sensor.period_of_day)
      selector:
        entity:
          domain: sensor

    podbitka_rogi:
      name: üí° ≈öwiat≈Ça podbitki ‚Äì rogi
      description: ≈öwiat≈Ça rogowe podbitki.
      selector:
        entity:
          domain: light

    podbitka_srodki:
      name: üí° ≈öwiat≈Ça podbitki ‚Äì ≈õrodki
      description: ≈öwiat≈Ça ≈õrodkowe podbitki.
      selector:
        entity:
          domain: light

    podjazd:
      name: üöó ≈öwiat≈Ça podjazdu
      description: O≈õwietlenie podjazdu.
      selector:
        entity:
          domain: light

    brama:
      name: üö™ Brama wjazdowa
      description: Encja bramy (cover), kt√≥ra wyzwala ≈õwiat≈Ça przy otwarciu.
      selector:
        entity:
          domain: cover

    drzwi:
      name: üö™ Drzwi wej≈õciowe
      description: Czujnik drzwi (binary_sensor), kt√≥ry wyzwala ≈õwiat≈Ça przy otwarciu.
      selector:
        entity:
          domain: binary_sensor

    swieta:
      name: üéÑ Prze≈ÇƒÖcznik ‚Äû≈öwiƒôta‚Äù
      description: Je≈õli w≈ÇƒÖczony, automatyzacja podbitki jest nieaktywna.
      selector:
        entity:
          domain: input_boolean

    # --- Parametry czasowe ---
    godzina_podbitka_srodki_off:
      name: üïô Godzina wy≈ÇƒÖczenia ≈õwiate≈Ç podbitki ‚Äì ≈õrodki
      default: "22:00:00"
      selector:
        time: {}

    godzina_podbitka_rogi_off:
      name: üï• Godzina wy≈ÇƒÖczenia ≈õwiate≈Ç podbitki ‚Äì rogi
      default: "22:30:00"
      selector:
        time: {}

    godzina_podbitka_rano:
      name: üåÖ Godzina aktywacji podbitki rano
      default: "06:00:00"
      selector:
        time: {}

    czas_swiecenia_podbitki:
      name: ‚è±Ô∏è Czas ≈õwiecenia ≈õwiate≈Ç podbitki (min)
      default: 5
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: min
          mode: slider

    czas_swiecenia_podjazdu:
      name: ‚è±Ô∏è Czas ≈õwiecenia ≈õwiate≈Ç podjazdu (min)
      default: 5
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: min
          mode: slider

mode: parallel

triggers:
  # Wiecz√≥r ‚Üí w≈ÇƒÖczenie podbitki
  - platform: state
    entity_id: !input czujnik_dnia
    from: daylight
    id: PodbitkaON

  # Poranek ‚Üí zmiana nightlight
  - platform: state
    entity_id: !input czujnik_dnia
    from: nightlight
    id: PodbitkaNightToDawn

  # Godzina 6:00 ‚Üí alternatywna aktywacja rano
  - platform: time
    at: !input godzina_podbitka_rano
    id: PodbitkaRANO

  # Otwarcie bramy
  - platform: state
    entity_id: !input brama
    to: opening
    id: BramaOPEN

  # Otwarcie drzwi
  - platform: state
    entity_id: !input drzwi
    to: "on"
    id: DrzwiOPEN

  # Blokada dzienna (≈õwit)
  - platform: state
    entity_id: !input czujnik_dnia
    from: dawnlight
    to: daylight
    id: BlokadaDziennaON

  # Odblokowanie wieczorem
  - platform: state
    entity_id: !input czujnik_dnia
    from: daylight
    to: dusklight
    id: BlokadaDziennaOFF

  # Tryb ≈õwiƒÖteczny
  - platform: state
    entity_id: !input swieta
    to: "on"
    id: SwietaON

  - platform: state
    entity_id: !input swieta
    to: "off"
    id: SwietaOFF

actions:
  - choose:

      # üü¢ TRYB: PODBITKA WIECZOREM
      - conditions:
          - condition: trigger
            id: PodbitkaON
          - condition: template
            value_template: "{{ not (tryb_swieta_aktywny | default(false)) }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id:
                - !input podbitka_rogi
                - !input podbitka_srodki
          - variables:
              tryb_podbitka_aktywny: true
          - wait_for_trigger:
              - platform: time
                at: !input godzina_podbitka_srodki_off
            continue_on_timeout: true
          - service: light.turn_off
            target:
              entity_id: !input podbitka_srodki
          - wait_for_trigger:
              - platform: time
                at: !input godzina_podbitka_rogi_off
            continue_on_timeout: true
          - service: light.turn_off
            target:
              entity_id: !input podbitka_rogi
          - variables:
              tryb_podbitka_aktywny: false

      # üü¢ TRYB: PODBITKA RANO
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: PodbitkaRANO
              - condition: trigger
                id: PodbitkaNightToDawn
          - condition: template
            value_template: "{{ not (tryb_swieta_aktywny | default(false)) }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id:
                - !input podbitka_rogi
                - !input podbitka_srodki
          - variables:
              tryb_podbitka_aktywny: true
          - wait_for_trigger:
              - platform: state
                entity_id: !input czujnik_dnia
                to: dawnlight
            continue_on_timeout: true
          - service: light.turn_off
            target:
              entity_id:
                - !input podbitka_rogi
                - !input podbitka_srodki
          - variables:
              tryb_podbitka_aktywny: false

      # üü¢ TRYB: PODJAZD PO BRAMIE
      - conditions:
          - condition: trigger
            id: BramaOPEN
          - condition: template
            value_template: "{{ not (tryb_podbitka_dzienny | default(false)) }}"
          - condition: or
            conditions:
              - condition: state
                entity_id: !input czujnik_dnia
                state: dusklight
              - condition: state
                entity_id: !input czujnik_dnia
                state: nightlight
              - condition: state
                entity_id: !input czujnik_dnia
                state: dawnlight
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input podjazd
          - delay:
              minutes: !input czas_swiecenia_podjazdu
          - service: light.turn_off
            target:
              entity_id: !input podjazd

      # üü¢ TRYB: PODBITKA PO BRAMIE
      - conditions:
          - condition: trigger
            id: BramaOPEN
          - condition: template
            value_template: "{{ not (tryb_swieta_aktywny | default(false)) and not (tryb_podbitka_dzienny | default(false)) and not (tryb_podbitka_aktywny | default(false)) }}"
        sequence:
          - delay: "00:00:30"
          - service: light.turn_on
            target:
              entity_id:
                - !input podbitka_rogi
                - !input podbitka_srodki
          - delay:
              minutes: !input czas_swiecenia_podbitki
          - service: light.turn_off
            target:
              entity_id:
                - !input podbitka_rogi
                - !input podbitka_srodki

      # üü¢ TRYB: PODBITKA PO DRZWIACH
      - conditions:
          - condition: trigger
            id: DrzwiOPEN
          - condition: template
            value_template: "{{ not (tryb_swieta_aktywny | default(false)) and not (tryb_podbitka_dzienny | default(false)) and not (tryb_podbitka_aktywny | default(false)) }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id:
                - !input podbitka_rogi
                - !input podbitka_srodki
          - delay:
              minutes: !input czas_swiecenia_podbitki
          - service: light.turn_off
            target:
              entity_id:
                - !input podbitka_rogi
                - !input podbitka_srodki

      # üü¢ TRYB: PODJAZD PO DRZWIACH
      - conditions:
          - condition: trigger
            id: DrzwiOPEN
          - condition: template
            value_template: "{{ not (tryb_podbitka_dzienny | default(false)) }}"
        sequence:
          - delay: "00:00:30"
          - service: light.turn_on
            target:
              entity_id: !input podjazd
          - delay:
              minutes: !input czas_swiecenia_podjazdu
          - service: light.turn_off
            target:
              entity_id: !input podjazd

      # üü¢ BLOKADA DZIENNA ‚Äì ≈öWIT ‚Üí DZIE≈É
      - conditions:
          - condition: trigger
            id: BlokadaDziennaON
        sequence:
          - variables:
              tryb_podbitka_dzienny: true

      # üü¢ BLOKADA DZIENNA OFF ‚Äì ZMIERZCH
      - conditions:
          - condition: trigger
            id: BlokadaDziennaOFF
        sequence:
          - variables:
              tryb_podbitka_dzienny: false

      # üéÑ TRYB: ≈öWIƒòTA ‚Äì blokada podbitki
      - conditions:
          - condition: trigger
            id: SwietaON
        sequence:
          - variables:
              tryb_swieta_aktywny: true

      # üéÑ TRYB: ≈öWIƒòTA OFF ‚Äì przywr√≥cenie normalnego dzia≈Çania
      - conditions:
          - condition: trigger
            id: SwietaOFF
        sequence:
          - variables:
              tryb_swieta_aktywny: false
