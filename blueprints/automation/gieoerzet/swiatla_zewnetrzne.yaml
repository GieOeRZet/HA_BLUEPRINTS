blueprint:
  name: ðŸ’¡ Podbitka â€“ Automatyczne Å›wiatÅ‚a + Brama
  description: >
    Kompleksowa automatyzacja oÅ›wietlenia podbitki:
    - WÅ‚Ä…cza o zmierzchu (gdy sensor.period_of_day â‰  daylight)
    - WyÅ‚Ä…cza o 22:00 etapami (Å›rodki â†’ rogi)
    - Rano o 6:00 wÅ‚Ä…cza, jeÅ›li nadal ciemno (nightlight lub dawnlight)
    - WyÅ‚Ä…cza przy daylight
    - WÅ‚Ä…cza na 5 minut przy otwieraniu bramy, jeÅ›li jest ciemno
    - Pomija dziaÅ‚anie, gdy input_boolean.swieta = ON

  domain: automation
  source_url: "https://raw.githubusercontent.com/GieOeRZet/akwarium/main/blueprints/automation/gieoerzet/swiatla_zewnetrzne.yaml"

  input:
    podbitka_all:
      name: ðŸ’¡ ÅšwiatÅ‚a podbitki â€“ caÅ‚oÅ›Ä‡
      description: GÅ‚Ã³wna grupa lub Å›wiatÅ‚a do wÅ‚Ä…czania/wyÅ‚Ä…czania caÅ‚oÅ›ci.
      selector:
        entity:
          domain: light

    podbitka_srodki:
      name: ðŸ’¡ ÅšwiatÅ‚a â€“ Å›rodki
      description: ÅšwiatÅ‚a Å›rodkowe do wyÅ‚Ä…czenia o 22:00.
      selector:
        entity:
          domain: light

    podbitka_rogi:
      name: ðŸ’¡ ÅšwiatÅ‚a â€“ rogi
      description: ÅšwiatÅ‚a rogowe do wyÅ‚Ä…czenia 30 minut po 22:00.
      selector:
        entity:
          domain: light

    brama:
      name: ðŸšª Brama wjazdowa
      description: Encja bramy (cover), przy ktÃ³rej otwieraniu Å›wiatÅ‚a majÄ… siÄ™ wÅ‚Ä…czaÄ‡.
      selector:
        entity:
          domain: cover

    czujnik_dnia:
      name: ðŸŒ… Sensor okresu dnia
      description: Sensor np. sensor.period_of_day z wartoÅ›ciami daylight / nightlight / dawnlight.
      selector:
        entity:
          domain: sensor

    swieta:
      name: ðŸŽ„ PrzeÅ‚Ä…cznik â€žÅšwiÄ™taâ€
      description: Nie uruchamiaj automatyzacji, jeÅ›li wÅ‚Ä…czony.
      selector:
        entity:
          domain: input_boolean

    godzina_off:
      name: ðŸ•™ Godzina wyÅ‚Ä…czenia wieczorem
      default: "22:00:00"
      selector:
        time: {}

    godzina_rano:
      name: ðŸŒ… Godzina wÅ‚Ä…czenia rano
      default: "06:00:00"
      selector:
        time: {}

mode: restart

triggers:
  - platform: state
    entity_id: !input czujnik_dnia
    from: daylight
    id: PodbitkaON

  - platform: state
    entity_id: !input czujnik_dnia
    to: daylight
    id: PodbitkaDaylightOFF

  - platform: time
    at: !input godzina_off
    id: PodbitkaOFF

  - platform: time
    at: !input godzina_rano
    id: PodbitkaRANO

  - platform: state
    entity_id: !input brama
    to: opening
    id: PodbitkaBRAMA

conditions:
  - condition: state
    entity_id: !input swieta
    state: "off"

actions:
  - choose:
      - conditions:
          - condition: trigger
            id: PodbitkaON
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input podbitka_all

      - conditions:
          - condition: trigger
            id: PodbitkaOFF
        sequence:
          - service: light.turn_off
            target:
              entity_id: !input podbitka_srodki
          - delay: "00:30:00"
          - service: light.turn_off
            target:
              entity_id: !input podbitka_rogi

      - conditions:
          - condition: trigger
            id: PodbitkaRANO
          - condition: or
            conditions:
              - condition: state
                entity_id: !input czujnik_dnia
                state: nightlight
              - condition: state
                entity_id: !input czujnik_dnia
                state: dawnlight
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input podbitka_all

      - conditions:
          - condition: trigger
            id: PodbitkaDaylightOFF
        sequence:
          - service: light.turn_off
            target:
              entity_id: !input podbitka_all

      # ---- BRAMA siÄ™ otwiera (nocÄ…) ----
      - conditions:
          - condition: trigger
            id: PodbitkaBRAMA
          - condition: template
            value_template: >
              {% set ent = (inputs.podbitka_all | default('')) %}
              {% if ent and states(ent) is defined %}
              {{ states(ent) == 'off' }}
              {% else %}
              true
              {% endif %}
          - condition: or
            conditions:
              - condition: state
                entity_id: !input czujnik_dnia
                state: nightlight
              - condition: state
                entity_id: !input czujnik_dnia
                state: dawnlight
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input podbitka_all
          - delay: "00:05:00"
          - service: light.turn_off
            target:
              entity_id: !input podbitka_all
