blueprint:
  name: Akwarium â€“ OÅ›wietlenie, COâ‚‚, Karmienie i Serwis
  description: |
    ğŸŒŠ Kompletny blueprint do sterowania akwarium.
    ObsÅ‚uguje 4 kanaÅ‚y oÅ›wietlenia, COâ‚‚, karmienie, tryb serwisowy
    oraz kontynuacjÄ™ rampy po restarcie Home Assistanta (z opÃ³Åºnieniem 10 s).
    Wszystkie sekcje sÄ… opcjonalne â€” brak encji = brak akcji.
  domain: automation
  source_url: https://github.com/GieOeRZet/akwarium/blob/main/blueprints/automation/gieoerzet/akwarium.yaml

  input:
    light_front:
      name: ğŸ’¡ BiaÅ‚y Front
      selector:
        entity: { domain: light }
    light_back:
      name: ğŸ’¡ BiaÅ‚y TyÅ‚ (opcjonalny)
      default: null
      selector:
        entity: { domain: light }
    light_sun:
      name: ğŸ’¡ Sun (opcjonalny)
      default: null
      selector:
        entity: { domain: light }
    light_grow:
      name: ğŸ’¡ Grow (opcjonalny)
      default: null
      selector:
        entity: { domain: light }

    front_start_time: { name: â° Start rozjaÅ›niania â€“ Front, default: "15:30:00", selector: { time: {} } }
    front_target_pct: { name: ğŸšï¸ Docelowa jasnoÅ›Ä‡ â€“ Front (%), default: 80, selector: { number: { min: 0, max: 100 } } }
    front_ramp_minutes: { name: ğŸ•’ Czas rozjaÅ›niania â€“ Front (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    front_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Front, default: "21:30:00", selector: { time: {} } }
    front_dim_minutes: { name: ğŸŒ™ Czas Å›ciemniania â€“ Front (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    back_start_time: { name: â° Start rozjaÅ›niania â€“ TyÅ‚, default: "15:30:00", selector: { time: {} } }
    back_target_pct: { name: ğŸšï¸ Docelowa jasnoÅ›Ä‡ â€“ TyÅ‚ (%), default: 80, selector: { number: { min: 0, max: 100 } } }
    back_ramp_minutes: { name: ğŸ•’ Czas rozjaÅ›niania â€“ TyÅ‚ (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    back_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ TyÅ‚, default: "21:30:00", selector: { time: {} } }
    back_dim_minutes: { name: ğŸŒ™ Czas Å›ciemniania â€“ TyÅ‚ (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    sun_start_time: { name: â° Start rozjaÅ›niania â€“ Sun, default: "15:30:00", selector: { time: {} } }
    sun_target_pct: { name: ğŸšï¸ Docelowa jasnoÅ›Ä‡ â€“ Sun (%), default: 70, selector: { number: { min: 0, max: 100 } } }
    sun_ramp_minutes: { name: ğŸ•’ Czas rozjaÅ›niania â€“ Sun (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    sun_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Sun, default: "21:30:00", selector: { time: {} } }
    sun_dim_minutes: { name: ğŸŒ™ Czas Å›ciemniania â€“ Sun (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    grow_start_time: { name: â° Start rozjaÅ›niania â€“ Grow, default: "15:30:00", selector: { time: {} } }
    grow_target_pct: { name: ğŸšï¸ Docelowa jasnoÅ›Ä‡ â€“ Grow (%), default: 85, selector: { number: { min: 0, max: 100 } } }
    grow_ramp_minutes: { name: ğŸ•’ Czas rozjaÅ›niania â€“ Grow (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    grow_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Grow, default: "21:30:00", selector: { time: {} } }
    grow_dim_minutes: { name: ğŸŒ™ Czas Å›ciemniania â€“ Grow (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    co2_switch: { name: ğŸ’¨ PrzeÅ‚Ä…cznik COâ‚‚ (opcjonalny), default: null, selector: { entity: { domain: switch } } }
    filter_switch: { name: ğŸ’§ PrzeÅ‚Ä…cznik Filtra (opcjonalny), default: null, selector: { entity: { domain: switch } } }
    feeding_switch: { name: ğŸ½ï¸ PrzeÅ‚Ä…cznik Karmienia (opcjonalny), default: null, selector: { entity: { domain: input_boolean } } }
    feeding_timer: { name: â³ Timer Karmienia (opcjonalny), default: null, selector: { entity: { domain: timer } } }
    feeding_duration: { name: â±ï¸ Czas Karmienia (min), default: 60, selector: { number: { min: 1, max: 120 } } }
    service_switch: { name: ğŸ”§ Tryb Serwisowy (opcjonalny), default: null, selector: { entity: { domain: input_boolean } } }
    memory_text: { name: ğŸ’¾ PamiÄ™Ä‡ Stanu (opcjonalny), default: null, selector: { entity: { domain: input_text } } }

trigger:
  - platform: time
    at:
      - !input front_start_time
      - !input front_dim_time
      - !input back_start_time
      - !input back_dim_time
      - !input sun_start_time
      - !input sun_dim_time
      - !input grow_start_time
      - !input grow_dim_time
  - platform: homeassistant
    event: start
  - platform: state
    entity_id: [!input feeding_switch, !input service_switch]
  - platform: event
    event_type: timer.finished
    event_data: { entity_id: !input feeding_timer }

variables:
  lights: { front: !input light_front, back: !input light_back, sun: !input light_sun, grow: !input light_grow }
  co2: !input co2_switch
  filter: !input filter_switch
  feed: !input feeding_switch
  feed_timer: !input feeding_timer
  feed_duration: !input feeding_duration
  service: !input service_switch
  memory: !input memory_text

mode: restart

action:
  - choose:
      - conditions: "{{ trigger.platform == 'homeassistant' }}"
        sequence:
          - delay: "00:00:10"
          - service: persistent_notification.create
            data: { title: "âš™ï¸ Blueprint Akwarium uruchomiony", message: "Oczekiwanie na zdarzenia." }

      - conditions: "{{ trigger.platform == 'time' }}"
        sequence:
          - repeat:
              for_each:
                - { entity: !input light_front, start: !input front_start_time, target: !input front_target_pct, ramp: !input front_ramp_minutes, dim_start: !input front_dim_time, dim_ramp: !input front_dim_minutes }
                - { entity: !input light_back, start: !input back_start_time, target: !input back_target_pct, ramp: !input back_ramp_minutes, dim_start: !input back_dim_time, dim_ramp: !input back_dim_minutes }
                - { entity: !input light_sun, start: !input sun_start_time, target: !input sun_target_pct, ramp: !input sun_ramp_minutes, dim_start: !input sun_dim_time, dim_ramp: !input sun_dim_minutes }
                - { entity: !input light_grow, start: !input grow_start_time, target: !input grow_target_pct, ramp: !input grow_ramp_minutes, dim_start: !input grow_dim_time, dim_ramp: !input grow_dim_minutes }
              sequence:
                - if: "{{ repeat.item.entity != None }}"
                  then:
                    - choose:
                        - conditions: "{{ trigger.now == repeat.item.start }}"
                          sequence:
                            - variables:
                                delay_s: "{{ (repeat.item.ramp|int * 60 / (repeat.item.target|int if repeat.item.target|int > 0 else 1)) | int }}"
                            - repeat:
                                while: >
                                  {{ repeat.index <= repeat.item.target|int and now().strftime('%H:%M:%S') < repeat.item.dim_start }}
                                sequence:
                                  - service: light.turn_on
                                    target: { entity_id: "{{ repeat.item.entity }}" }
                                    data: { brightness_step_pct: 1 }
                                  - delay: { seconds: "{{ delay_s }}" }
                        - conditions: "{{ trigger.now == repeat.item.dim_start }}"
                          sequence:
                            - variables:
                                delay_s: "{{ (repeat.item.dim_ramp|int * 60 / (repeat.item.target|int if repeat.item.target|int > 0 else 1)) | int }}"
                            - repeat:
                                count: "{{ repeat.item.target|int }}"
                                sequence:
                                  - service: light.turn_on
                                    target: { entity_id: "{{ repeat.item.entity }}" }
                                    data: { brightness_step_pct: -1 }
                                  - delay: { seconds: "{{ delay_s }}" }
                            - service: light.turn_off
                              target: { entity_id: "{{ repeat.item.entity }}" }
