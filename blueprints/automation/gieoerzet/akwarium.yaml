# =====================================================================
# ğŸŒŠ Home Assistant Blueprint: Akwarium â€“ OÅ›wietlenie, COâ‚‚, Karmienie i Serwis
# Autor: GieOeRZet
# Wersja: 2025.10.19
# Opis:
#   Kompletny blueprint do automatyzacji akwarium.
#   Sterowanie oÅ›wietleniem (4 kanaÅ‚y), COâ‚‚, filtrem, trybem karmienia i serwisowym.
#   ObsÅ‚uguje pÅ‚ynne rampy jasnoÅ›ci, automatyczne wyÅ‚Ä…czenie COâ‚‚,
#   tryb serwisowy z pamiÄ™ciÄ… stanu (jasnoÅ›Ä‡ + on/off) i restart z opÃ³Åºnieniem.
#
# Repozytorium:
#   https://github.com/GieOeRZet/akwarium
#
# Licencja: MIT
# =====================================================================

blueprint:
  name: ğŸŒŠ Akwarium â€“ OÅ›wietlenie, COâ‚‚, Karmienie i Serwis
  description: |
    Kompletny blueprint do automatyzacji akwarium.
    Sterowanie oÅ›wietleniem (4 kanaÅ‚y), COâ‚‚, filtrem, trybem karmienia i serwisowym.
    ObsÅ‚uguje pÅ‚ynne rampy rozjaÅ›niania/Å›ciemniania z kontynuacjÄ… po restarcie.
    Wszystkie sekcje sÄ… opcjonalne â€” brak encji = brak akcji.
  domain: automation
  source_url: https://github.com/GieOeRZet/akwarium/blob/main/blueprints/automation/gieoerzet/akwarium.yaml

  input:
    # --- Sekcja I: OÅšWIETLENIE ---
    light_front:
      name: ğŸ’¡ BiaÅ‚y Front (wymagany)
      selector: { entity: { domain: light } }

    light_back:
      name: ğŸ’¡ BiaÅ‚y TyÅ‚ (opcjonalny)
      default: null
      selector: { entity: { domain: light } }

    light_sun:
      name: â˜€ï¸ Sun (opcjonalny)
      default: null
      selector: { entity: { domain: light } }

    light_grow:
      name: ğŸŒ¿ Grow (opcjonalny)
      default: null
      selector: { entity: { domain: light } }

    # --- Harmonogram kanaÅ‚Ã³w ---
    front_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ Front, default: "15:30:00", selector: { time: {} } }
    front_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ Front (%), default: 80, selector: { number: { min: 0, max: 100 } } }
    front_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ Front (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    front_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Front, default: "21:30:00", selector: { time: {} } }
    front_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ Front (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    back_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ TyÅ‚, default: "15:30:00", selector: { time: {} } }
    back_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ TyÅ‚ (%), default: 80, selector: { number: { min: 0, max: 100 } } }
    back_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ TyÅ‚ (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    back_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ TyÅ‚, default: "21:30:00", selector: { time: {} } }
    back_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ TyÅ‚ (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    sun_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ Sun, default: "15:30:00", selector: { time: {} } }
    sun_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ Sun (%), default: 70, selector: { number: { min: 0, max: 100 } } }
    sun_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ Sun (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    sun_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Sun, default: "21:30:00", selector: { time: {} } }
    sun_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ Sun (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    grow_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ Grow, default: "15:30:00", selector: { time: {} } }
    grow_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ Grow (%), default: 85, selector: { number: { min: 0, max: 100 } } }
    grow_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ Grow (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    grow_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Grow, default: "21:30:00", selector: { time: {} } }
    grow_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ Grow (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    # --- Sekcja II: COâ‚‚ i filtr ---
    co2_switch: { name: ğŸ’¨ PrzeÅ‚Ä…cznik COâ‚‚ (opcjonalny), default: null, selector: { entity: { domain: switch } } }
    filter_switch: { name: ğŸ’§ PrzeÅ‚Ä…cznik Filtra (opcjonalny), default: null, selector: { entity: { domain: switch } } }

    # --- Sekcja III: Karmienie i Serwis ---
    feeding_switch: { name: ğŸ½ï¸ PrzeÅ‚Ä…cznik Karmienia (opcjonalny), default: null, selector: { entity: { domain: input_boolean } } }
    feeding_timer: { name: â³ Timer Karmienia (opcjonalny), default: null, selector: { entity: { domain: timer } } }
    feeding_duration: { name: â±ï¸ Czas Karmienia (min), default: 60, selector: { number: { min: 1, max: 120 } } }
    service_switch: { name: ğŸ”§ Tryb Serwisowy (opcjonalny), default: null, selector: { entity: { domain: input_boolean } } }
    memory_text: { name: ğŸ’¾ PamiÄ™Ä‡ Stanu (opcjonalny), default: null, selector: { entity: { domain: input_text } } }

trigger:
  - platform: homeassistant
    event: start
  - platform: state
    entity_id:
      - !input feeding_switch
      - !input service_switch
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: !input feeding_timer

variables:
  lights:
    front: !input light_front
    back: !input light_back
    sun: !input light_sun
    grow: !input light_grow
  filter: !input filter_switch
  feed: !input feeding_switch
  feed_timer: !input feeding_timer
  feed_duration: !input feeding_duration
  service: !input service_switch
  memory: !input memory_text

mode: restart

action:
  - choose:
      # --- â±ï¸ Restart HA ---
      - conditions: "{{ trigger.platform == 'homeassistant' }}"
        sequence:
          - delay: "00:00:10"
          - service: persistent_notification.create
            data:
              title: "âš™ï¸ Blueprint Akwarium uruchomiony"
              message: "Home Assistant gotowy â€“ automatyzacje wznowione."

      # --- ğŸ½ï¸ Tryb karmienia ---
      - conditions:
          - "{{ feed is not none }}"
          - condition: template
            value_template: "{{ trigger.entity_id == feed }}"
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input feeding_switch
                    state: "on"
                sequence:
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ½ï¸ Tryb karmienia aktywny"
                      message: "Filtr wyÅ‚Ä…czony na {{ feed_duration }} minut."
                  - if: "{{ filter is not none }}"
                    then:
                      - service: switch.turn_off
                        target: { entity_id: "{{ filter }}" }
                  - if: "{{ feed_timer is not none }}"
                    then:
                      - service: timer.start
                        target: { entity_id: "{{ feed_timer }}" }
                        data: { duration: "{{ (feed_duration|int * 60)|int }}" }

              - conditions:
                  - condition: state
                    entity_id: !input feeding_switch
                    state: "off"
                sequence:
                  - if: "{{ filter is not none }}"
                    then:
                      - service: switch.turn_on
                        target: { entity_id: "{{ filter }}" }
                  - if: "{{ feed_timer is not none }}"
                    then:
                      - service: timer.cancel
                        target: { entity_id: "{{ feed_timer }}" }
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ½ï¸ Karmienie zakoÅ„czone"
                      message: "Filtr ponownie wÅ‚Ä…czony."
