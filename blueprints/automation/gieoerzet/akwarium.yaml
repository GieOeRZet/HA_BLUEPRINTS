blueprint:
  name: ğŸŒŠ Akwarium â€“ OÅ›wietlenie, COâ‚‚, Karmienie i Serwis
  description: |
    Kompletny blueprint do automatyzacji akwarium.
    Zawiera sterowanie oÅ›wietleniem (4 kanaÅ‚y), COâ‚‚, filtrem, trybem karmienia i serwisowym.
    ObsÅ‚uguje rampy rozjaÅ›niania/Å›ciemniania z pÅ‚ynnym przejÅ›ciem 1% i kontynuacjÄ… po restarcie.
    Wszystkie sekcje sÄ… opcjonalne â€” brak encji = brak akcji.
  domain: automation
  source_url: https://github.com/GieOeRZet/akwarium/blob/main/blueprints/automation/gieoerzet/akwarium.yaml

  input:
    # --- Sekcja I: OÅšWIETLENIE ---
    light_front:
      name: ğŸ’¡ BiaÅ‚y Front (wymagany)
      selector:
        entity:
          domain: light

    light_back:
      name: ğŸ’¡ BiaÅ‚y TyÅ‚ (opcjonalny)
      default: null
      selector:
        entity:
          domain: light

    light_sun:
      name: â˜€ï¸ Sun (opcjonalny)
      default: null
      selector:
        entity:
          domain: light

    light_grow:
      name: ğŸŒ¿ Grow (opcjonalny)
      default: null
      selector:
        entity:
          domain: light

    # --- Harmonogram kanaÅ‚Ã³w ---
    front_start_time:
      name: ğŸ•’ Start rozjaÅ›niania â€“ Front
      default: "15:30:00"
      selector: { time: {} }

    front_target_pct:
      name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ Front (%)
      default: 80
      selector: { number: { min: 0, max: 100 } }

    front_ramp_minutes:
      name: â±ï¸ Czas rozjaÅ›niania â€“ Front (min)
      default: 30
      selector: { number: { min: 1, max: 240 } }

    front_dim_time:
      name: ğŸŒ™ Start Å›ciemniania â€“ Front
      default: "21:30:00"
      selector: { time: {} }

    front_dim_minutes:
      name: â±ï¸ Czas Å›ciemniania â€“ Front (min)
      default: 30
      selector: { number: { min: 1, max: 240 } }

    # --- Dla pozostaÅ‚ych kanaÅ‚Ã³w ---
    back_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ TyÅ‚, default: "15:30:00", selector: { time: {} } }
    back_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ TyÅ‚ (%), default: 80, selector: { number: { min: 0, max: 100 } } }
    back_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ TyÅ‚ (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    back_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ TyÅ‚, default: "21:30:00", selector: { time: {} } }
    back_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ TyÅ‚ (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    sun_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ Sun, default: "15:30:00", selector: { time: {} } }
    sun_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ Sun (%), default: 70, selector: { number: { min: 0, max: 100 } } }
    sun_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ Sun (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    sun_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Sun, default: "21:30:00", selector: { time: {} } }
    sun_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ Sun (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    grow_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ Grow, default: "15:30:00", selector: { time: {} } }
    grow_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ Grow (%), default: 85, selector: { number: { min: 0, max: 100 } } }
    grow_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ Grow (min), default: 30, selector: { number: { min: 1, max: 240 } } }
    grow_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Grow, default: "21:30:00", selector: { time: {} } }
    grow_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ Grow (min), default: 30, selector: { number: { min: 1, max: 240 } } }

    # --- Sekcja II: COâ‚‚ i filtr ---
    co2_switch:
      name: ğŸ’¨ PrzeÅ‚Ä…cznik COâ‚‚ (opcjonalny)
      default: null
      selector:
        entity: { domain: switch }

    filter_switch:
      name: ğŸ’§ PrzeÅ‚Ä…cznik Filtra (opcjonalny)
      default: null
      selector:
        entity: { domain: switch }

    # --- Sekcja III: Karmienie i Serwis ---
    feeding_switch:
      name: ğŸ½ï¸ PrzeÅ‚Ä…cznik Karmienia (opcjonalny)
      default: null
      selector:
        entity: { domain: input_boolean }

    feeding_timer:
      name: â³ Timer Karmienia (opcjonalny)
      default: null
      selector:
        entity: { domain: timer }

    feeding_duration:
      name: â±ï¸ Czas Karmienia (min)
      default: 60
      selector:
        number: { min: 1, max: 120 }

    service_switch:
      name: ğŸ”§ Tryb Serwisowy (opcjonalny)
      default: null
      selector:
        entity: { domain: input_boolean }

    memory_text:
      name: ğŸ’¾ PamiÄ™Ä‡ Stanu (opcjonalny)
      default: null
      selector:
        entity: { domain: input_text }

# =========================
# WYZWALACZE
# =========================
trigger:
  - platform: time
    at:
      - !input front_start_time
      - !input front_dim_time
      - !input back_start_time
      - !input back_dim_time
      - !input sun_start_time
      - !input sun_dim_time
      - !input grow_start_time
      - !input grow_dim_time

  - platform: homeassistant
    event: start

  - platform: state
    entity_id:
      - !input feeding_switch
      - !input service_switch

  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: !input feeding_timer

# =========================
# ZMIENNE
# =========================
variables:
  lights:
    front: !input light_front
    back: !input light_back
    sun: !input light_sun
    grow: !input light_grow
  co2: !input co2_switch
  filter: !input filter_switch
  feed: !input feeding_switch
  feed_timer: !input feeding_timer
  feed_duration: !input feeding_duration
  service: !input service_switch
  memory: !input memory_text

mode: restart

# =========================
# AKCJE
# =========================
action:
  - choose:
      # === Restart Home Assistanta ===
      - conditions: "{{ trigger.platform == 'homeassistant' }}"
        sequence:
          - delay: "00:00:10"
          - service: persistent_notification.create
            data:
              title: "âš™ï¸ Blueprint Akwarium uruchomiony"
              message: "Home Assistant w peÅ‚ni zaÅ‚adowany â€“ oczekiwanie na zdarzenia."

      # === Rampa jasnoÅ›ci ===
      - conditions: "{{ trigger.platform == 'time' }}"
        sequence:
          - repeat:
              for_each:
                - { entity: !input light_front, start: !input front_start_time, target: !input front_target_pct, ramp: !input front_ramp_minutes, dim_start: !input front_dim_time, dim_ramp: !input front_dim_minutes }
                - { entity: !input light_back, start: !input back_start_time, target: !input back_target_pct, ramp: !input back_ramp_minutes, dim_start: !input back_dim_time, dim_ramp: !input back_dim_minutes }
                - { entity: !input light_sun, start: !input sun_start_time, target: !input sun_target_pct, ramp: !input sun_ramp_minutes, dim_start: !input sun_dim_time, dim_ramp: !input sun_dim_minutes }
                - { entity: !input light_grow, start: !input grow_start_time, target: !input grow_target_pct, ramp: !input grow_ramp_minutes, dim_start: !input grow_dim_time, dim_ramp: !input grow_dim_minutes }
              sequence:
                - if: "{{ repeat.item.entity != None }}"
                  sequence:
                    - choose:
                        # --- RozjaÅ›nianie ---
                        - conditions: "{{ trigger.now == repeat.item.start }}"
                          sequence:
                            - service: persistent_notification.create
                              data:
                                title: "ğŸ’¡ RozpoczÄ™to rampÄ™ (rozjaÅ›nianie)"
                                message: "{{ repeat.item.entity }} â€“ do {{ repeat.item.target }}% w {{ repeat.item.ramp }} min."
                            - variables:
                                delay_s: "{{ (repeat.item.ramp|int * 60 / (repeat.item.target|int if repeat.item.target|int > 0 else 1)) | int }}"
                            - repeat:
                                while: >
                                  {{ repeat.index <= repeat.item.target|int and now().strftime('%H:%M:%S') < repeat.item.dim_start }}
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ repeat.item.entity }}"
                                    data:
                                      brightness_step_pct: 1
                                  - delay:
                                      seconds: "{{ delay_s }}"
                            - service: persistent_notification.create
                              data:
                                title: "ğŸ’¡ ZakoÅ„czono rampÄ™ (rozjaÅ›nianie)"
                                message: "{{ repeat.item.entity }} osiÄ…gnÄ™Å‚o {{ repeat.item.target }}%."
                        # --- Åšciemnianie ---
                        - conditions: "{{ trigger.now == repeat.item.dim_start }}"
                          sequence:
                            - service: persistent_notification.create
                              data:
                                title: "ğŸŒ™ RozpoczÄ™to rampÄ™ (Å›ciemnianie)"
                                message: "{{ repeat.item.entity }} â€“ do 0% w {{ repeat.item.dim_ramp }} min."
                            - variables:
                                delay_s: "{{ (repeat.item.dim_ramp|int * 60 / (repeat.item.target|int if repeat.item.target|int > 0 else 1)) | int }}"
                            - repeat:
                                count: "{{ repeat.item.target|int }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ repeat.item.entity }}"
                                    data:
                                      brightness_step_pct: -1
                                  - delay:
                                      seconds: "{{ delay_s }}"
                            - service: light.turn_off
                              target:
                                entity_id: "{{ repeat.item.entity }}"
                            - service: persistent_notification.create
                              data:
                                title: "ğŸŒ™ ZakoÅ„czono rampÄ™ (Å›ciemnianie)"
                                message: "{{ repeat.item.entity }} wyÅ‚Ä…czone."

      # ==========================================
      # ğŸ’¨ Sekcja COâ‚‚ â€“ uruchamianie i wyÅ‚Ä…czanie wg rampy
      # ==========================================
      - conditions: "{{ co2 is not none }}"
        sequence:
          # Wyznacz najwczeÅ›niejszy czas rozjaÅ›niania i Å›ciemniania
          - variables:
              start_times:
                - !input front_start_time
                - !input back_start_time
                - !input sun_start_time
                - !input grow_start_time
              dim_times:
                - !input front_dim_time
                - !input back_dim_time
                - !input sun_dim_time
                - !input grow_dim_time
              earliest_start: "{{ start_times | reject('equalto', None) | min }}"
              earliest_dim: "{{ dim_times | reject('equalto', None) | min }}"
          # --- WÅ‚Ä…cz COâ‚‚ o najwczeÅ›niejszej godzinie rampy ---
          - choose:
              - conditions: "{{ trigger.now == earliest_start }}"
                sequence:
                  - service: switch.turn_on
                    target: { entity_id: "{{ co2 }}" }
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ’¨ COâ‚‚ wÅ‚Ä…czone"
                      message: "Aktywacja COâ‚‚ o {{ earliest_start }}"
              # --- WyÅ‚Ä…cz COâ‚‚ 30 minut przed najwczeÅ›niejszym Å›ciemnianiem ---
              - conditions: "{{ trigger.now == (earliest_dim | as_datetime | as_local - timedelta(minutes=30)) }}"
                sequence:
                  - service: switch.turn_off
                    target: { entity_id: "{{ co2 }}" }
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ’¨ COâ‚‚ wyÅ‚Ä…czone"
                      message: "WyÅ‚Ä…czenie 30 minut przed Å›ciemnianiem ({{ earliest_dim }})"

      # ==========================================
      # ğŸ½ï¸ Sekcja Karmienia â€“ sterowanie filtrem i timerem
      # ==========================================
      - conditions: "{{ feed is not none and filter is not none }}"
        sequence:
          - choose:
              # --- RozpoczÄ™cie karmienia ---
              - conditions: "{{ trigger.entity_id == feed and is_state(feed, 'on') }}"
                sequence:
                  - service: switch.turn_off
                    target: { entity_id: "{{ filter }}" }
                  - service: timer.start
                    target: { entity_id: "{{ feed_timer }}" }
                    data:
                      duration: "{{ (feed_duration|int * 60)|int }}"
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ½ï¸ RozpoczÄ™to karmienie"
                      message: "Filtr wyÅ‚Ä…czony na {{ feed_duration }} minut."
              # --- ZakoÅ„czenie karmienia (rÄ™czne wyÅ‚Ä…czenie) ---
              - conditions: "{{ trigger.entity_id == feed and is_state(feed, 'off') }}"
                sequence:
                  - service: switch.turn_on
                    target: { entity_id: "{{ filter }}" }
                  - service: timer.cancel
                    target: { entity_id: "{{ feed_timer }}" }
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ½ï¸ Karmienie zakoÅ„czone"
                      message: "Filtr wÅ‚Ä…czony, timer zatrzymany."
              # --- ZakoÅ„czenie karmienia po odliczaniu timera ---
              - conditions: "{{ trigger.event_type == 'timer.finished' }}"
                sequence:
                  - service: switch.turn_on
                    target: { entity_id: "{{ filter }}" }
                  - service: input_boolean.turn_off
                    target: { entity_id: "{{ feed }}" }
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ½ï¸ Karmienie zakoÅ„czone (timer)"
                      message: "Filtr ponownie wÅ‚Ä…czony po zakoÅ„czeniu odliczania."

      # ==========================================
      # ğŸ”§ Sekcja Serwis â€“ zapamiÄ™tywanie i przywracanie stanu
      # ==========================================
      - conditions: "{{ service is not none and memory is not none }}"
        sequence:
          - choose:
              # --- Aktywacja trybu serwisowego ---
              - conditions: "{{ trigger.entity_id == service and is_state(service, 'on') }}"
                sequence:
                  # Zapisz aktualne stany Å›wiateÅ‚ i filtra w pomocniku input_text
                  - variables:
                      saved_state: |
                        {% set data = namespace(states={}) %}
                        {% if filter is not none %}
                        {% set data.states = data.states | combine({filter: states(filter)}) %}
                        {% endif %}
                        {% for l in [lights.front, lights.back, lights.sun, lights.grow] if l is not none %}
                        {% set data.states = data.states | combine({l: states(l)}) %}
                        {% endfor %}
                        {{ data.states | tojson }}
                  - service: input_text.set_value
                    target: { entity_id: "{{ memory }}" }
                    data: { value: "{{ saved_state }}" }
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ”§ Tryb serwisowy aktywowany"
                      message: "Zapisano stan, Å›wiatÅ‚a ustawione na 90%, filtr wyÅ‚Ä…czony."
                  # Ustaw wszystkie Å›wiatÅ‚a na 90% i wyÅ‚Ä…cz filtr
                  - repeat:
                      for_each: "{{ [lights.front, lights.back, lights.sun, lights.grow] | select('string') }}"
                      sequence:
                        - if: "{{ repeat.item != None }}"
                          sequence:
                            - service: light.turn_on
                              target: { entity_id: "{{ repeat.item }}" }
                              data: { brightness_pct: 90 }
                  - if: "{{ filter is not none }}"
                    sequence:
                      - service: switch.turn_off
                        target: { entity_id: "{{ filter }}" }

              # --- WyÅ‚Ä…czenie trybu serwisowego ---
              - conditions: "{{ trigger.entity_id == service and is_state(service, 'off') }}"
                sequence:
                  - variables:
                      state_data: "{{ states(memory) }}"
                  - choose:
                      - conditions: "{{ state_data != '' }}"
                        sequence:
                          - variables:
                              parsed: "{{ state_data | from_json }}"
                          - repeat:
                              for_each: "{{ parsed.keys() }}"
                              sequence:
                                - variables:
                                    e: "{{ repeat.item }}"
                                    val: "{{ parsed[e] }}"
                                - choose:
                                    - conditions: "{{ e.startswith('light.') }}"
                                      sequence:
                                        - service: "light.turn_{{ 'on' if val == 'on' else 'off' }}"
                                          target: { entity_id: "{{ e }}" }
                                    - conditions: "{{ e.startswith('switch.') }}"
                                      sequence:
                                        - service: "switch.turn_{{ 'on' if val == 'on' else 'off' }}"
                                          target: { entity_id: "{{ e }}" }
                          - service: persistent_notification.create
                            data:
                              title: "ğŸ”§ Tryb serwisowy zakoÅ„czony"
                              message: "PrzywrÃ³cono poprzedni stan Å›wiateÅ‚ i filtra."

      # ==========================================
      # ğŸ©º Sekcja diagnostyczna â€“ informacje pomocnicze
      # ==========================================
      - service: persistent_notification.create
        data:
          title: "ğŸ©º Diagnostyka blueprintu Akwarium"
          message: |
            ğŸ’¡ KanaÅ‚y aktywne: {{ [lights.front, lights.back, lights.sun, lights.grow] | select('string') | list }}
            ğŸ’¨ COâ‚‚: {{ co2 if co2 else 'brak' }}
            ğŸ’§ Filtr: {{ filter if filter else 'brak' }}
            ğŸ½ï¸ Karmienie: {{ feed if feed else 'brak' }}
            ğŸ”§ Serwis: {{ service if service else 'brak' }}
