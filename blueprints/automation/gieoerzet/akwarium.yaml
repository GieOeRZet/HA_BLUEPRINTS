# =====================================================================
# ğŸŒŠ Home Assistant Blueprint: Akwarium â€“ OÅ›wietlenie, COâ‚‚ i Karmienie
# Autor: GieOeRZet
# Wersja: 2025.1.005
# Repozytorium: https://github.com/GieOeRZet/akwarium
# Licencja: MIT
# =====================================================================

blueprint:
  name: ğŸŒŠ Akwarium â€“ OÅ›wietlenie, COâ‚‚ i Karmienie
  description: |
    Kompletny blueprint do automatyzacji akwarium.
    ObsÅ‚uguje rampy oÅ›wietlenia (Shelly RGBW2), COâ‚‚ oraz karmienie z timerem automatycznym.
    Rampy automatycznie wznawiajÄ… siÄ™ po restarcie Home Assistant i sÄ… kontynuowane co minutÄ™.
  domain: automation
  source_url: https://github.com/GieOeRZet/akwarium/blob/main/blueprints/automation/gieoerzet/akwarium.yaml

  input:
    # --- OÅ›wietlenie -------------------------------------------------
    light_front:
      name: ğŸ’¡ BiaÅ‚y Front (wymagany)
      selector: { entity: { domain: light } }
    light_back:
      name: ğŸ’¡ BiaÅ‚y TyÅ‚ (opcjonalny)
      default: null
      selector: { entity: { domain: light } }
    light_sun:
      name: â˜€ï¸ Sun (opcjonalny)
      default: null
      selector: { entity: { domain: light } }
    light_grow:
      name: ğŸŒ¿ Grow (opcjonalny)
      default: null
      selector: { entity: { domain: light } }

    # --- Harmonogram ramp --------------------------------------------
    front_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ Front, default: "15:30:00", selector: { time: {} } }
    front_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ Front, default: 80, selector: { number: { min: 0, max: 100 } } }
    front_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ Front, default: 30, selector: { number: { min: 1, max: 240 } } }
    front_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Front, default: "21:30:00", selector: { time: {} } }
    front_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ Front, default: 30, selector: { number: { min: 1, max: 240 } } }

    back_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ TyÅ‚, default: "15:30:00", selector: { time: {} } }
    back_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ TyÅ‚, default: 80, selector: { number: { min: 0, max: 100 } } }
    back_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ TyÅ‚, default: 30, selector: { number: { min: 1, max: 240 } } }
    back_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ TyÅ‚, default: "21:30:00", selector: { time: {} } }
    back_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ TyÅ‚, default: 30, selector: { number: { min: 1, max: 240 } } }

    sun_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ Sun, default: "15:30:00", selector: { time: {} } }
    sun_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ Sun, default: 70, selector: { number: { min: 0, max: 100 } } }
    sun_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ Sun, default: 30, selector: { number: { min: 1, max: 240 } } }
    sun_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Sun, default: "21:30:00", selector: { time: {} } }
    sun_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ Sun, default: 30, selector: { number: { min: 1, max: 240 } } }

    grow_start_time: { name: ğŸ•’ Start rozjaÅ›niania â€“ Grow, default: "15:30:00", selector: { time: {} } }
    grow_target_pct: { name: ğŸšï¸ JasnoÅ›Ä‡ docelowa â€“ Grow, default: 85, selector: { number: { min: 0, max: 100 } } }
    grow_ramp_minutes: { name: â±ï¸ Czas rozjaÅ›niania â€“ Grow, default: 30, selector: { number: { min: 1, max: 240 } } }
    grow_dim_time: { name: ğŸŒ™ Start Å›ciemniania â€“ Grow, default: "21:30:00", selector: { time: {} } }
    grow_dim_minutes: { name: â±ï¸ Czas Å›ciemniania â€“ Grow, default: 30, selector: { number: { min: 1, max: 240 } } }

    # --- COâ‚‚ / Filtr / Karmienie -------------------------------------
    co2_switch: { name: ğŸ’¨ COâ‚‚, default: null, selector: { entity: { domain: switch } } }
    filter_switch: { name: ğŸ’§ Filtr, default: null, selector: { entity: { domain: switch } } }
    feeding_switch: { name: ğŸ½ï¸ Karmienie, default: null, selector: { entity: { domain: input_boolean } } }
    feeding_timer: { name: â³ Timer karmienia, default: null, selector: { entity: { domain: timer } } }
    feeding_duration: { name: â±ï¸ Czas karmienia (min), default: 60, selector: { number: { min: 1, max: 120 } } }

# -------------------- WYZWALACZE ------------------------------------
trigger:
  - platform: homeassistant
    event: start
  - platform: time_pattern
    minutes: "/1"
  - platform: state
    entity_id: !input feeding_switch
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: !input feeding_timer

# -------------------- ZMIENNE ---------------------------------------
variables:
  lights:
    front: !input light_front
    back: !input light_back
    sun: !input light_sun
    grow: !input light_grow
  co2: !input co2_switch
  filter: !input filter_switch
  feed: !input feeding_switch
  feed_timer: !input feeding_timer
  feed_duration: !input feeding_duration

mode: restart

# -------------------- AKCJE -----------------------------------------
action:
  - choose:
      # --- âš™ï¸ Start HA + kompensacja / aktualizacja ramp -------------
      - conditions: "{{ trigger.platform in ['homeassistant','time_pattern'] }}"
        sequence:
          - repeat:
              for_each:
                - { entity: "{{ lights.front }}", start: !input front_start_time, target: !input front_target_pct, ramp: !input front_ramp_minutes, dim: !input front_dim_time, dim_ramp: !input front_dim_minutes }
                - { entity: "{{ lights.back }}", start: !input back_start_time, target: !input back_target_pct, ramp: !input back_ramp_minutes, dim: !input back_dim_time, dim_ramp: !input back_dim_minutes }
                - { entity: "{{ lights.sun }}", start: !input sun_start_time, target: !input sun_target_pct, ramp: !input sun_ramp_minutes, dim: !input sun_dim_time, dim_ramp: !input sun_dim_minutes }
                - { entity: "{{ lights.grow }}", start: !input grow_start_time, target: !input grow_target_pct, ramp: !input grow_ramp_minutes, dim: !input grow_dim_time, dim_ramp: !input grow_dim_minutes }
              sequence:
                - if: "{{ repeat.item.entity is not none }}"
                  then:
                    - variables:
                        now_ts: "{{ as_timestamp(now()) }}"
                        start_ts: "{{ as_timestamp(as_datetime(now().strftime('%Y-%m-%dT' ~ repeat.item.start))) }}"
                        dim_ts: "{{ as_timestamp(as_datetime(now().strftime('%Y-%m-%dT' ~ repeat.item.dim))) }}"
                        ramp_end: "{{ start_ts + (repeat.item.ramp|int * 60) }}"
                        dim_end: "{{ dim_ts + (repeat.item.dim_ramp|int * 60) }}"
                    - choose:
                        # FAZA ROZJAÅšNIANIA
                        - conditions: "{{ start_ts <= now_ts <= ramp_end }}"
                          sequence:
                            - variables:
                                elapsed: "{{ (now_ts - start_ts) / 60 }}"
                                pct: "{{ (elapsed / repeat.item.ramp|float) * repeat.item.target|float | round(1) }}"
                            - service: light.turn_on
                              target: { entity_id: "{{ repeat.item.entity }}" }
                              data: { brightness_pct: "{{ [pct, repeat.item.target]|min }}" }

                        # PEÅNA JASNOÅšÄ†
                        - conditions: "{{ ramp_end < now_ts < dim_ts }}"
                          sequence:
                            - service: light.turn_on
                              target: { entity_id: "{{ repeat.item.entity }}" }
                              data: { brightness_pct: "{{ repeat.item.target }}" }

                        # FAZA ÅšCIEMNIANIA
                        - conditions: "{{ dim_ts <= now_ts <= dim_end }}"
                          sequence:
                            - variables:
                                elapsed_dim: "{{ (now_ts - dim_ts) / 60 }}"
                                pct: "{{ repeat.item.target|float - ((elapsed_dim / repeat.item.dim_ramp|float) * repeat.item.target|float) | round(1) }}"
                            - service: light.turn_on
                              target: { entity_id: "{{ repeat.item.entity }}" }
                              data: { brightness_pct: "{{ [pct, 0]|max }}" }

                        # POZA ZAKRESEM â€“ WYÅÄ„CZ
                        - conditions: "{{ now_ts > dim_end or now_ts < start_ts }}"
                          sequence:
                            - service: light.turn_off
                              target: { entity_id: "{{ repeat.item.entity }}" }

      # --- ğŸ’¨ COâ‚‚ -----------------------------------------------------
      - conditions: "{{ co2 is not none }}"
        sequence:
          - variables:
              start_times:
                - !input front_start_time
                - !input back_start_time
                - !input sun_start_time
                - !input grow_start_time
              dim_times:
                - !input front_dim_time
                - !input back_dim_time
                - !input sun_dim_time
                - !input grow_dim_time
              earliest_start: "{{ start_times | reject('equalto', None) | min }}"
              earliest_dim: "{{ dim_times | reject('equalto', None) | min }}"
          - choose:
              - conditions: "{{ trigger.now.strftime('%H:%M:%S') == earliest_start }}"
                sequence:
                  - service: switch.turn_on
                    target: { entity_id: "{{ co2 }}" }
              - conditions: >
                  {{ trigger.now.strftime('%H:%M:%S') ==
                     (as_datetime(now().strftime('%Y-%m-%dT' ~ earliest_dim))
                      - timedelta(minutes=30)).strftime('%H:%M:%S') }}
                sequence:
                  - service: switch.turn_off
                    target: { entity_id: "{{ co2 }}" }

      # --- ğŸ½ï¸ Karmienie ----------------------------------------------
      - conditions: "{{ feed is not none and filter is not none }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.entity_id == feed and is_state(feed, 'on') }}"
                sequence:
                  - service: switch.turn_off
                    target: { entity_id: "{{ filter }}" }
                  - service: timer.start
                    target: { entity_id: "{{ feed_timer }}" }
                    data: { duration: "{{ (feed_duration|int * 60)|int }}" }
              - conditions: "{{ trigger.entity_id == feed and is_state(feed, 'off') }}"
                sequence:
                  - service: switch.turn_on
                    target: { entity_id: "{{ filter }}" }
                  - service: timer.cancel
                    target: { entity_id: "{{ feed_timer }}" }
              - conditions: "{{ trigger.event_type == 'timer.finished' }}"
                sequence:
                  - service: switch.turn_on
                    target: { entity_id: "{{ filter }}" }
                  - service: input_boolean.turn_off
                    target: { entity_id: "{{ feed }}" }

      # --- ğŸ©º Diagnostyka ---------------------------------------------
      - conditions: []
        sequence:
          - service: persistent_notification.create
            data:
              title: "ğŸ©º Diagnostyka blueprintu Akwarium"
              message: |
                ğŸ’¡ KanaÅ‚y: {{ [lights.front, lights.back, lights.sun, lights.grow] | select('string') | list }}
                ğŸ’¨ COâ‚‚: {{ co2 if co2 else 'brak' }}
                ğŸ’§ Filtr: {{ filter if filter else 'brak' }}
                ğŸ½ï¸ Karmienie: {{ feed if feed else 'brak' }}

# =====================================================================
# KONIEC BLUEPRINTU â€“ wersja 2025.1.005
# =====================================================================
