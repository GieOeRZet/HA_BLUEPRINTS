blueprint:
  name: Akwarium â€“ OÅ›wietlenie, COâ‚‚, Karmienie i Serwis
  description: |
    ğŸŒŠ Kompletny blueprint do sterowania akwarium.
    ObsÅ‚uguje 4 kanaÅ‚y oÅ›wietlenia, COâ‚‚, karmienie, tryb serwisowy
    oraz kontynuacjÄ™ rampy po restarcie Home Assistanta (z opÃ³Åºnieniem 10 s).
    Zawiera minimalistyczne powiadomienia diagnostyczne z emoji.
    Wszystkie sekcje sÄ… opcjonalne â€” brak encji = brak akcji.
  source_url: https://github.com/GieOeRZet/akwarium/blob/main/blueprints/automation/gieoerzet/akwarium.yaml
  domain: automation

  input:
    # === KanaÅ‚y oÅ›wietlenia ===
    light_front:
      name: ğŸ’¡ BiaÅ‚y Front
      selector:
        entity:
          domain: light
    light_back:
      name: ğŸ’¡ BiaÅ‚y TyÅ‚ (opcjonalny)
      default: null
      selector:
        entity:
          domain: light
    light_sun:
      name: ğŸ’¡ Sun (opcjonalny)
      default: null
      selector:
        entity:
          domain: light
    light_grow:
      name: ğŸ’¡ Grow (opcjonalny)
      default: null
      selector:
        entity:
          domain: light

    # === Parametry ramp ===
    front_start_time:
      name: â° Start rozjaÅ›niania â€“ Front
      default: '15:30:00'
      selector:
        time: {}
    front_target_pct:
      name: ğŸšï¸ Docelowa jasnoÅ›Ä‡ â€“ Front (%)
      default: 80
      selector:
        number:
          min: 0
          max: 100
    front_ramp_minutes:
      name: ğŸ•’ Czas rozjaÅ›niania (min) â€“ Front
      default: 30
      selector:
        number:
          min: 1
          max: 240
    front_dim_time:
      name: ğŸŒ™ Start Å›ciemniania â€“ Front
      default: '21:30:00'
      selector:
        time: {}
    front_dim_minutes:
      name: ğŸŒ™ Czas Å›ciemniania (min) â€“ Front
      default: 30
      selector:
        number:
          min: 1
          max: 240

    # === TyÅ‚ ===
    back_start_time:
      name: â° Start rozjaÅ›niania â€“ TyÅ‚
      default: '15:30:00'
      selector:
        time: {}
    back_target_pct:
      name: ğŸšï¸ Docelowa jasnoÅ›Ä‡ â€“ TyÅ‚ (%)
      default: 80
      selector:
        number:
          min: 0
          max: 100
    back_ramp_minutes:
      name: ğŸ•’ Czas rozjaÅ›niania (min) â€“ TyÅ‚
      default: 30
      selector:
        number:
          min: 1
          max: 240
    back_dim_time:
      name: ğŸŒ™ Start Å›ciemniania â€“ TyÅ‚
      default: '21:30:00'
      selector:
        time: {}
    back_dim_minutes:
      name: ğŸŒ™ Czas Å›ciemniania (min) â€“ TyÅ‚
      default: 30
      selector:
        number:
          min: 1
          max: 240

    # === Sun ===
    sun_start_time:
      name: â° Start rozjaÅ›niania â€“ Sun
      default: '15:30:00'
      selector:
        time: {}
    sun_target_pct:
      name: ğŸšï¸ Docelowa jasnoÅ›Ä‡ â€“ Sun (%)
      default: 70
      selector:
        number:
          min: 0
          max: 100
    sun_ramp_minutes:
      name: ğŸ•’ Czas rozjaÅ›niania (min) â€“ Sun
      default: 30
      selector:
        number:
          min: 1
          max: 240
    sun_dim_time:
      name: ğŸŒ™ Start Å›ciemniania â€“ Sun
      default: '21:30:00'
      selector:
        time: {}
    sun_dim_minutes:
      name: ğŸŒ™ Czas Å›ciemniania (min) â€“ Sun
      default: 30
      selector:
        number:
          min: 1
          max: 240

    # === Grow ===
    grow_start_time:
      name: â° Start rozjaÅ›niania â€“ Grow
      default: '15:30:00'
      selector:
        time: {}
    grow_target_pct:
      name: ğŸšï¸ Docelowa jasnoÅ›Ä‡ â€“ Grow (%)
      default: 85
      selector:
        number:
          min: 0
          max: 100
    grow_ramp_minutes:
      name: ğŸ•’ Czas rozjaÅ›niania (min) â€“ Grow
      default: 30
      selector:
        number:
          min: 1
          max: 240
    grow_dim_time:
      name: ğŸŒ™ Start Å›ciemniania â€“ Grow
      default: '21:30:00'
      selector:
        time: {}
    grow_dim_minutes:
      name: ğŸŒ™ Czas Å›ciemniania (min) â€“ Grow
      default: 30
      selector:
        number:
          min: 1
          max: 240

    # === Sekcje opcjonalne ===
    co2_switch:
      name: ğŸ’¨ PrzeÅ‚Ä…cznik COâ‚‚ (opcjonalny)
      default: null
      selector:
        entity:
          domain: switch

    filter_switch:
      name: ğŸ’§ PrzeÅ‚Ä…cznik Filtra (opcjonalny)
      default: null
      selector:
        entity:
          domain: switch

    feeding_switch:
      name: ğŸ½ï¸ PrzeÅ‚Ä…cznik Karmienia (opcjonalny)
      default: null
      selector:
        entity:
          domain: input_boolean

    feeding_timer:
      name: â³ Timer Karmienia (opcjonalny)
      default: null
      selector:
        entity:
          domain: timer

    feeding_duration:
      name: â±ï¸ Czas Karmienia (min)
      default: 60
      selector:
        number:
          min: 1
          max: 120

    service_switch:
      name: ğŸ”§ Tryb Serwisowy (opcjonalny)
      default: null
      selector:
        entity:
          domain: input_boolean

    memory_text:
      name: ğŸ’¾ PamiÄ™Ä‡ Stanu (opcjonalny input_text)
      default: null
      selector:
        entity:
          domain: input_text

trigger:
  # Czasowe wyzwalacze dla ramp rozjaÅ›niania i Å›ciemniania
  - platform: time
    at:
      - !input front_start_time
      - !input front_dim_time
      - !input back_start_time
      - !input back_dim_time
      - !input sun_start_time
      - !input sun_dim_time
      - !input grow_start_time
      - !input grow_dim_time

  # Restart Home Assistanta
  - platform: homeassistant
    event: start

  # Karmienie / Serwis
  - platform: state
    entity_id:
      - !input feeding_switch
      - !input service_switch

  # ZakoÅ„czenie timera karmienia
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: !input feeding_timer

variables:
  lights:
    front: !input light_front
    back: !input light_back
    sun: !input light_sun
    grow: !input light_grow
  co2: !input co2_switch
  filter: !input filter_switch
  feed: !input feeding_switch
  feed_timer: !input feeding_timer
  feed_duration: !input feeding_duration
  service: !input service_switch
  memory: !input memory_text

mode: restart

action:
  - choose:
      # ==========================================
      # âš™ï¸ Po restarcie Home Assistanta
      # ==========================================
      - conditions: "{{ trigger.platform == 'homeassistant' }}"
        sequence:
          - delay: "00:00:10"  # opÃ³Åºnienie 10 sekund
          - service: persistent_notification.create
            data:
              title: "âš™ï¸ Blueprint Akwarium uruchomiony"
              message: "Konfiguracja zaÅ‚adowana â€“ oczekiwanie na kolejne zdarzenia."
          - variables:
              now_time: "{{ now().strftime('%H:%M:%S') }}"
          - repeat:
              for_each:
                - { entity: !input light_front, start: !input front_start_time, target: !input front_target_pct, ramp: !input front_ramp_minutes, dim_start: !input front_dim_time, dim_ramp: !input front_dim_minutes }
                - { entity: !input light_back, start: !input back_start_time, target: !input back_target_pct, ramp: !input back_ramp_minutes, dim_start: !input back_dim_time, dim_ramp: !input back_dim_minutes }
                - { entity: !input light_sun, start: !input sun_start_time, target: !input sun_target_pct, ramp: !input sun_ramp_minutes, dim_start: !input sun_dim_time, dim_ramp: !input sun_dim_minutes }
                - { entity: !input light_grow, start: !input grow_start_time, target: !input grow_target_pct, ramp: !input grow_ramp_minutes, dim_start: !input grow_dim_time, dim_ramp: !input grow_dim_minutes }
              sequence:
                - if: "{{ repeat.item.entity != None }}"
                  then:
                    - variables:
                        start_dt: "{{ strptime(repeat.item.start, '%H:%M:%S') }}"
                        dim_dt: "{{ strptime(repeat.item.dim_start, '%H:%M:%S') }}"
                        now_dt: "{{ strptime(now_time, '%H:%M:%S') }}"
                        ramp_secs: "{{ repeat.item.ramp|int * 60 }}"
                        dim_secs: "{{ repeat.item.dim_ramp|int * 60 }}"
                    - choose:
                        # RozjaÅ›nianie â€“ jeÅ›li restart nastÄ…piÅ‚ w trakcie rampy
                        - conditions: "{{ start_dt <= now_dt < start_dt + timedelta(seconds=ramp_secs) }}"
                          sequence:
                            - variables:
                                elapsed: "{{ (now_dt - start_dt).total_seconds() }}"
                                pct: "{{ (elapsed / ramp_secs * repeat.item.target)|int }}"
                            - service: light.turn_on
                              target:
                                entity_id: "{{ repeat.item.entity }}"
                              data:
                                brightness_pct: "{{ pct }}"
                            - service: persistent_notification.create
                              data:
                                title: "ğŸ’¡ Kontynuacja rampy (rozjaÅ›nianie)"
                                message: "{{ repeat.item.entity }} ustawiono na {{ pct }}%."
                        # Åšciemnianie â€“ jeÅ›li restart nastÄ…piÅ‚ w trakcie Å›ciemniania
                        - conditions: "{{ dim_dt <= now_dt < dim_dt + timedelta(seconds=dim_secs) }}"
                          sequence:
                            - variables:
                                elapsed: "{{ (now_dt - dim_dt).total_seconds() }}"
                                pct: "{{ (repeat.item.target - (elapsed / dim_secs * repeat.item.target))|int }}"
                            - service: light.turn_on
                              target:
                                entity_id: "{{ repeat.item.entity }}"
                              data:
                                brightness_pct: "{{ pct if pct > 0 else 0 }}"
                            - service: persistent_notification.create
                              data:
                                title: "ğŸŒ™ Kontynuacja rampy (Å›ciemnianie)"
                                message: "{{ repeat.item.entity }} ustawiono na {{ pct }}%."

      # ==========================================
      # ğŸ’¡ Rampa jasnoÅ›ci (rozjaÅ›nianie i Å›ciemnianie)
      # ==========================================
      - conditions: "{{ trigger.platform == 'time' }}"
        sequence:
          - repeat:
              for_each:
                - { entity: !input light_front, start: !input front_start_time, target: !input front_target_pct, ramp: !input front_ramp_minutes, dim_start: !input front_dim_time, dim_ramp: !input front_dim_minutes }
                - { entity: !input light_back, start: !input back_start_time, target: !input back_target_pct, ramp: !input back_ramp_minutes, dim_start: !input back_dim_time, dim_ramp: !input back_dim_minutes }
                - { entity: !input light_sun, start: !input sun_start_time, target: !input sun_target_pct, ramp: !input sun_ramp_minutes, dim_start: !input sun_dim_time, dim_ramp: !input sun_dim_minutes }
                - { entity: !input light_grow, start: !input grow_start_time, target: !input grow_target_pct, ramp: !input grow_ramp_minutes, dim_start: !input grow_dim_time, dim_ramp: !input grow_dim_minutes }
              sequence:
                - if: "{{ repeat.item.entity != None }}"
                  then:
                    - choose:
                        # === RozjaÅ›nianie ===
                        - conditions: "{{ trigger.now == repeat.item.start }}"
                          sequence:
                            - service: persistent_notification.create
                              data:
                                title: "ğŸ’¡ RozpoczÄ™to rampÄ™ (rozjaÅ›nianie)"
                                message: "{{ repeat.item.entity }} â€“ do {{ repeat.item.target }}% w {{ repeat.item.ramp }} min."
                            - variables:
                                delay_s: "{{ (repeat.item.ramp|int * 60 / (repeat.item.target|int if repeat.item.target|int > 0 else 1)) | int }}"
                            - repeat:
                                while: >
                                  {{ repeat.index <= repeat.item.target|int }}
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ repeat.item.entity }}"
                                    data:
                                      brightness_step_pct: 1
                                  - delay:
                                      seconds: "{{ delay_s }}"
                                  # Zabezpieczenie â€“ przerwij rozjaÅ›nianie, jeÅ›li zaczyna siÄ™ Å›ciemnianie
                                  - if: "{{ now().strftime('%H:%M:%S') >= repeat.item.dim_start }}"
                                    then:
                                      - service: persistent_notification.create
                                        data:
                                          title: "ğŸŒ™ Przerwano rozjaÅ›nianie"
                                          message: "{{ repeat.item.entity }} â€“ rozpoczÄ™to Å›ciemnianie."
                                      - break
                            - service: persistent_notification.create
                              data:
                                title: "ğŸ’¡ ZakoÅ„czono rampÄ™ (rozjaÅ›nianie)"
                                message: "{{ repeat.item.entity }} osiÄ…gnÄ™Å‚o {{ repeat.item.target }}%."
                        # === Åšciemnianie ===
                        - conditions: "{{ trigger.now == repeat.item.dim_start }}"
                          sequence:
                            - service: persistent_notification.create
                              data:
                                title: "ğŸŒ™ RozpoczÄ™to rampÄ™ (Å›ciemnianie)"
                                message: "{{ repeat.item.entity }} â€“ do 0% w {{ repeat.item.dim_ramp }} min."
                            - variables:
                                delay_s: "{{ (repeat.item.dim_ramp|int * 60 / (repeat.item.target|int if repeat.item.target|int > 0 else 1)) | int }}"
                            - repeat:
                                count: "{{ repeat.item.target|int }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ repeat.item.entity }}"
                                    data:
                                      brightness_step_pct: -1
                                  - delay:
                                      seconds: "{{ delay_s }}"
                            - service: light.turn_off
                              target:
                                entity_id: "{{ repeat.item.entity }}"
                            - service: persistent_notification.create
                              data:
                                title: "ğŸŒ™ ZakoÅ„czono rampÄ™ (Å›ciemnianie)"
                                message: "{{ repeat.item.entity }} wyÅ‚Ä…czone."

      # ==========================================
      # ğŸ’¨ COâ‚‚ â€“ wg najwczeÅ›niejszej rampy
      # ==========================================
      - conditions: "{{ co2 is not none }}"
        sequence:
          - variables:
              start_times:
                - !input front_start_time
                - !input back_start_time
                - !input sun_start_time
                - !input grow_start_time
              dim_times:
                - !input front_dim_time
                - !input back_dim_time
                - !input sun_dim_time
                - !input grow_dim_time
              earliest_start: "{{ start_times | reject('equalto', None) | min }}"
              earliest_dim: "{{ dim_times | reject('equalto', None) | min }}"
          - choose:
              # WÅ‚Ä…czenie COâ‚‚ o najwczeÅ›niejszym starcie rampy
              - conditions: "{{ trigger.now == earliest_start }}"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: "{{ co2 }}"
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ’¨ COâ‚‚ wÅ‚Ä…czone"
                      message: "Aktywacja COâ‚‚ o {{ earliest_start }}"
              # WyÅ‚Ä…czenie COâ‚‚ 30 minut przed najwczeÅ›niejszym Å›ciemnianiem
              - conditions: "{{ trigger.now == (earliest_dim | as_datetime | as_local - timedelta(minutes=30)) }}"
                sequence:
                  - service: switch.turn_off
                    target:
                      entity_id: "{{ co2 }}"
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ’¨ COâ‚‚ wyÅ‚Ä…czone"
                      message: "WyÅ‚Ä…czenie 30 min przed Å›ciemnianiem ({{ earliest_dim }})"

      # ==========================================
      # ğŸ½ï¸ Karmienie â€“ wyÅ‚Ä…cza filtr, uruchamia timer
      # ==========================================
      - conditions: "{{ feed is not none and filter is not none }}"
        sequence:
          - choose:
              # WÅ‚Ä…czono karmienie
              - conditions: "{{ trigger.entity_id == feed and is_state(feed, 'on') }}"
                sequence:
                  - service: switch.turn_off
                    target:
                      entity_id: "{{ filter }}"
                  - service: timer.start
                    target:
                      entity_id: "{{ feed_timer }}"
                    data:
                      duration: "{{ (feed_duration|int * 60)|int }}"
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ½ï¸ RozpoczÄ™to karmienie"
                      message: "Filtr wyÅ‚Ä…czony na {{ feed_duration }} minut."
              # WyÅ‚Ä…czono karmienie rÄ™cznie
              - conditions: "{{ trigger.entity_id == feed and is_state(feed, 'off') }}"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: "{{ filter }}"
                  - service: timer.cancel
                    target:
                      entity_id: "{{ feed_timer }}"
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ½ï¸ ZakoÅ„czono karmienie"
                      message: "Filtr wÅ‚Ä…czony, timer zatrzymany."
              # ZakoÅ„czony timer karmienia
              - conditions: "{{ trigger.event_type == 'timer.finished' }}"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: "{{ filter }}"
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ feed }}"
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ½ï¸ ZakoÅ„czono karmienie (timer)"
                      message: "Filtr ponownie wÅ‚Ä…czony."

      # ==========================================
      # ğŸ”§ Tryb serwisowy â€“ zapamiÄ™tuje i przywraca stany
      # ==========================================
      - conditions: "{{ service is not none and memory is not none }}"
        sequence:
          - choose:
              # WÅ‚Ä…czono serwis
              - conditions: "{{ trigger.entity_id == service and is_state(service, 'on') }}"
                sequence:
                  - variables:
                      saved_state: |
                        {% set data = namespace(states={}) %}
                        {% if filter is not none %}
                        {% set data.states = data.states | combine({filter: states(filter)}) %}
                        {% endif %}
                        {% for l in [lights.front, lights.back, lights.sun, lights.grow] if l is not none %}
                        {% set data.states = data.states | combine({l: states(l)}) %}
                        {% endfor %}
                        {{ data.states | tojson }}
                  - service: input_text.set_value
                    target:
                      entity_id: "{{ memory }}"
                    data:
                      value: "{{ saved_state }}"
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ”§ Tryb serwisowy aktywowany"
                      message: "Zapisano stan, Å›wiatÅ‚a ustawione na 90%, filtr wyÅ‚Ä…czony."
                  - repeat:
                      for_each: "{{ [lights.front, lights.back, lights.sun, lights.grow] | select('string') }}"
                      sequence:
                        - if: "{{ repeat.item != None }}"
                          then:
                            - service: light.turn_on
                              target:
                                entity_id: "{{ repeat.item }}"
                              data:
                                brightness_pct: 90
                  - if: "{{ filter is not none }}"
                    then:
                      - service: switch.turn_off
                        target:
                          entity_id: "{{ filter }}"
              # WyÅ‚Ä…czono serwis
              - conditions: "{{ trigger.entity_id == service and is_state(service, 'off') }}"
                sequence:
                  - variables:
                      state_data: "{{ states(memory) }}"
                  - choose:
                      - conditions: "{{ state_data != '' }}"
                        sequence:
                          - variables:
                              parsed: "{{ state_data | from_json }}"
                          - repeat:
                              for_each: "{{ parsed.keys() }}"
                              sequence:
                                - variables:
                                    e: "{{ repeat.item }}"
                                    val: "{{ parsed[e] }}"
                                - choose:
                                    - conditions: "{{ e.startswith('light.') }}"
                                      sequence:
                                        - service: "light.turn_{{ 'on' if val == 'on' else 'off' }}"
                                          target:
                                            entity_id: "{{ e }}"
                                    - conditions: "{{ e.startswith('switch.') }}"
                                      sequence:
                                        - service: "switch.turn_{{ 'on' if val == 'on' else 'off' }}"
                                          target:
                                            entity_id: "{{ e }}"
                          - service: persistent_notification.create
                            data:
                              title: "ğŸ”§ Tryb serwisowy zakoÅ„czony"
                              message: "PrzywrÃ³cono poprzedni stan Å›wiateÅ‚ i filtra."
