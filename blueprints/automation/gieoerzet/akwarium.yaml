# =====================================================================
# ğŸŒŠ Home Assistant Blueprint: Akwarium â€“ OÅ›wietlenie, COâ‚‚ i Karmienie
# Autor: GieOeRZet
# Wersja: 2025.02.UI1 (FINAL â€“ odÅ›wieÅ¼ony interfejs)
# Repozytorium: https://github.com/GieOeRZet/akwarium
# Licencja: MIT
# =====================================================================

blueprint:
  name: ğŸŒŠ Akwarium â€“ OÅ›wietlenie, COâ‚‚ i Karmienie
  description: |
    Kompletny blueprint do automatyzacji akwarium w Home Assistant.
    ğŸ  Steruje rampami oÅ›wietlenia (Shelly RGBW2 â€“ 4 kanaÅ‚y), COâ‚‚, filtrem i karmieniem.
    âš™ï¸ Posiada peÅ‚nÄ… kompensacjÄ™ ramp po restarcie Home Assistant i aktualizacjÄ™ co minutÄ™.
    ğŸ“˜ Dokumentacja i wykresy ramp: [GitHub â€“ GieOeRZet / akwarium](https://github.com/GieOeRZet/akwarium)
  domain: automation
  source_url: https://github.com/GieOeRZet/akwarium/blob/main/blueprints/automation/gieoerzet/akwarium.yaml

  input:
    # ================================================================
    # ğŸ’¡ OÅšWIETLENIE â€“ FRONT
    # ================================================================
    header_front:
      name: "ğŸ’¡ â€”â€”â€” KanaÅ‚ 1: Front â€”â€”â€”"
      default: ""
      selector: { text: {} }

    light_front:
      name: ğŸ’¡ ÅšwiatÅ‚o Front
      description: "GÅ‚Ã³wne przednie Å›wiatÅ‚o akwarium (kanaÅ‚ 1 â€“ wymagane)."
      selector: { entity: { domain: light } }

    front_start_time:
      name: ğŸ•’ Start rozjaÅ›niania
      description: "Godzina rozpoczÄ™cia rampy rozjaÅ›niania dla Å›wiatÅ‚a Front."
      default: "15:30:00"
      selector: { time: {} }

    front_target_pct:
      name: ğŸšï¸ JasnoÅ›Ä‡ docelowa
      description: "Docelowa jasnoÅ›Ä‡ po zakoÅ„czeniu rampy rozjaÅ›niania (%)."
      default: 80
      selector: { number: { min: 0, max: 100 } }

    front_ramp_minutes:
      name: â±ï¸ Czas rozjaÅ›niania
      description: "DÅ‚ugoÅ›Ä‡ rampy rozjaÅ›niania (w minutach)."
      default: 30
      selector: { number: { min: 1, max: 240 } }

    front_dim_time:
      name: ğŸŒ™ Start Å›ciemniania
      description: "Godzina rozpoczÄ™cia rampy Å›ciemniania dla Å›wiatÅ‚a Front."
      default: "21:30:00"
      selector: { time: {} }

    front_dim_minutes:
      name: â±ï¸ Czas Å›ciemniania
      description: "DÅ‚ugoÅ›Ä‡ rampy Å›ciemniania (w minutach)."
      default: 30
      selector: { number: { min: 1, max: 240 } }

    # ================================================================
    # ğŸ’¡ OÅšWIETLENIE â€“ BACK
    # ================================================================
    header_back:
      name: "ğŸ’¡ â€”â€”â€” KanaÅ‚ 2: Back â€”â€”â€”"
      default: ""
      selector: { text: {} }

    light_back:
      name: ğŸ’¡ ÅšwiatÅ‚o TyÅ‚
      description: "Drugie Å›wiatÅ‚o akwarium (kanaÅ‚ 2 â€“ opcjonalne)."
      default: null
      selector: { entity: { domain: light } }

    back_start_time:
      name: ğŸ•’ Start rozjaÅ›niania
      description: "Godzina rozpoczÄ™cia rampy rozjaÅ›niania dla Å›wiatÅ‚a Back."
      default: "15:30:00"
      selector: { time: {} }

    back_target_pct:
      name: ğŸšï¸ JasnoÅ›Ä‡ docelowa
      description: "Docelowa jasnoÅ›Ä‡ dla Å›wiatÅ‚a Back (%)."
      default: 80
      selector: { number: { min: 0, max: 100 } }

    back_ramp_minutes:
      name: â±ï¸ Czas rozjaÅ›niania
      description: "DÅ‚ugoÅ›Ä‡ rampy rozjaÅ›niania (minuty)."
      default: 30
      selector: { number: { min: 1, max: 240 } }

    back_dim_time:
      name: ğŸŒ™ Start Å›ciemniania
      description: "Godzina rozpoczÄ™cia rampy Å›ciemniania."
      default: "21:30:00"
      selector: { time: {} }

    back_dim_minutes:
      name: â±ï¸ Czas Å›ciemniania
      description: "DÅ‚ugoÅ›Ä‡ rampy Å›ciemniania (minuty)."
      default: 30
      selector: { number: { min: 1, max: 240 } }

    # ================================================================
    # â˜€ï¸ OÅšWIETLENIE â€“ SUN
    # ================================================================
    header_sun:
      name: "â˜€ï¸ â€”â€”â€” KanaÅ‚ 3: Sun â€”â€”â€”"
      default: ""
      selector: { text: {} }

    light_sun:
      name: â˜€ï¸ ÅšwiatÅ‚o Sun
      description: "Trzecie Å›wiatÅ‚o (kanaÅ‚ 3 â€“ opcjonalne, symuluje promienie sÅ‚oneczne)."
      default: null
      selector: { entity: { domain: light } }

    sun_start_time:
      name: ğŸ•’ Start rozjaÅ›niania
      description: "Godzina rozpoczÄ™cia rampy rozjaÅ›niania dla Å›wiatÅ‚a Sun."
      default: "15:30:00"
      selector: { time: {} }

    sun_target_pct:
      name: ğŸšï¸ JasnoÅ›Ä‡ docelowa
      description: "Docelowa jasnoÅ›Ä‡ dla Å›wiatÅ‚a Sun (%)."
      default: 70
      selector: { number: { min: 0, max: 100 } }

    sun_ramp_minutes:
      name: â±ï¸ Czas rozjaÅ›niania
      description: "Czas rampy rozjaÅ›niania dla Sun (minuty)."
      default: 30
      selector: { number: { min: 1, max: 240 } }

    sun_dim_time:
      name: ğŸŒ™ Start Å›ciemniania
      description: "Godzina rozpoczÄ™cia rampy Å›ciemniania dla Sun."
      default: "21:30:00"
      selector: { time: {} }

    sun_dim_minutes:
      name: â±ï¸ Czas Å›ciemniania
      description: "Czas rampy Å›ciemniania (minuty)."
      default: 30
      selector: { number: { min: 1, max: 240 } }

    # ================================================================
    # ğŸŒ¿ OÅšWIETLENIE â€“ GROW
    # ================================================================
    header_grow:
      name: "ğŸŒ¿ â€”â€”â€” KanaÅ‚ 4: Grow â€”â€”â€”"
      default: ""
      selector: { text: {} }

    light_grow:
      name: ğŸŒ¿ ÅšwiatÅ‚o Grow
      description: "Czwarte Å›wiatÅ‚o (kanaÅ‚ 4 â€“ opcjonalne, wspomaga wzrost roÅ›lin)."
      default: null
      selector: { entity: { domain: light } }

    grow_start_time:
      name: ğŸ•’ Start rozjaÅ›niania
      description: "Godzina rozpoczÄ™cia rampy rozjaÅ›niania dla Å›wiatÅ‚a Grow."
      default: "15:30:00"
      selector: { time: {} }

    grow_target_pct:
      name: ğŸšï¸ JasnoÅ›Ä‡ docelowa
      description: "Docelowa jasnoÅ›Ä‡ Å›wiatÅ‚a Grow (%)."
      default: 85
      selector: { number: { min: 0, max: 100 } }

    grow_ramp_minutes:
      name: â±ï¸ Czas rozjaÅ›niania
      description: "Czas rampy rozjaÅ›niania (minuty)."
      default: 30
      selector: { number: { min: 1, max: 240 } }

    grow_dim_time:
      name: ğŸŒ™ Start Å›ciemniania
      description: "Godzina rozpoczÄ™cia rampy Å›ciemniania dla Grow."
      default: "21:30:00"
      selector: { time: {} }

    grow_dim_minutes:
      name: â±ï¸ Czas Å›ciemniania
      description: "Czas rampy Å›ciemniania (minuty)."
      default: 30
      selector: { number: { min: 1, max: 240 } }

    # ================================================================
    # ğŸ’¨ COâ‚‚ / ğŸ’§ FILTR / ğŸ½ï¸ KARMIENIE
    # ================================================================
    header_other:
      name: "âš™ï¸ â€”â€”â€” PozostaÅ‚e funkcje â€”â€”â€”"
      default: ""
      selector: { text: {} }

    co2_switch:
      name: ğŸ’¨ COâ‚‚
      description: "PrzeÅ‚Ä…cznik zaworu COâ‚‚ (opcjonalny). WÅ‚Ä…cza siÄ™ przy starcie ramp i wyÅ‚Ä…cza 30 minut przed Å›ciemnianiem."
      default: null
      selector: { entity: { domain: switch } }

    filter_switch:
      name: ğŸ’§ Filtr
      description: "Steruje filtrem akwarium. WyÅ‚Ä…czany automatycznie podczas karmienia."
      default: null
      selector: { entity: { domain: switch } }

    feeding_switch:
      name: ğŸ½ï¸ Karmienie
      description: "PrzeÅ‚Ä…cznik (input_boolean) uruchamiajÄ…cy tryb karmienia. WyÅ‚Ä…cza filtr i startuje timer."
      default: null
      selector: { entity: { domain: input_boolean } }

    feeding_timer:
      name: â³ Timer karmienia
      description: "Timer kontrolujÄ…cy dÅ‚ugoÅ›Ä‡ karmienia. Po zakoÅ„czeniu wÅ‚Ä…cza filtr i wyÅ‚Ä…cza karmienie."
      default: null
      selector: { entity: { domain: timer } }

    feeding_duration:
      name: â±ï¸ Czas karmienia (min)
      description: "Czas trwania karmienia w minutach (domyÅ›lnie 60)."
      default: 60
      selector: { number: { min: 1, max: 120 } }

# -------------------- WYZWALACZE ------------------------------------
trigger:
  - platform: homeassistant
    event: start
  - platform: time_pattern
    minutes: "/1"
  - platform: state
    entity_id: !input feeding_switch
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: !input feeding_timer

# -------------------- ZMIENNE ---------------------------------------
variables:
  lights:
    front: !input light_front
    back: !input light_back
    sun: !input light_sun
    grow: !input light_grow
  co2: !input co2_switch
  filter: !input filter_switch
  feed: !input feeding_switch
  feed_timer: !input feeding_timer
  feed_duration: !input feeding_duration

mode: restart

# -------------------- AKCJE -----------------------------------------
action:
  - choose:
      # --- âš™ï¸ Kompensacja i rampy co minutÄ™ -------------------------
      - conditions: "{{ trigger.platform == 'homeassistant' or trigger.platform == 'time_pattern' }}"
        sequence:
          - repeat:
              for_each:
                - { entity: "{{ lights.front }}", start: !input front_start_time, target: !input front_target_pct, ramp: !input front_ramp_minutes, dim: !input front_dim_time, dim_ramp: !input front_dim_minutes }
                - { entity: "{{ lights.back }}", start: !input back_start_time, target: !input back_target_pct, ramp: !input back_ramp_minutes, dim: !input back_dim_time, dim_ramp: !input back_dim_minutes }
                - { entity: "{{ lights.sun }}", start: !input sun_start_time, target: !input sun_target_pct, ramp: !input sun_ramp_minutes, dim: !input sun_dim_time, dim_ramp: !input sun_dim_minutes }
                - { entity: "{{ lights.grow }}", start: !input grow_start_time, target: !input grow_target_pct, ramp: !input grow_ramp_minutes, dim: !input grow_dim_time, dim_ramp: !input grow_dim_minutes }
              sequence:
                - if: "{{ repeat.item.entity is not none }}"
                  then:
                    - variables:
                        now_ts: "{{ as_timestamp(now()) }}"
                        start_ts: "{{ as_timestamp(as_datetime(now().strftime('%Y-%m-%dT' ~ repeat.item.start))) }}"
                        ramp_end: "{{ start_ts + repeat.item.ramp|int * 60 }}"
                        dim_ts: "{{ as_timestamp(as_datetime(now().strftime('%Y-%m-%dT' ~ repeat.item.dim))) }}"
                        dim_end: "{{ dim_ts + repeat.item.dim_ramp|int * 60 }}"
                    - choose:
                        - conditions: "{{ start_ts <= now_ts <= ramp_end }}"
                          sequence:
                            - variables:
                                elapsed: "{{ (now_ts - start_ts) / 60 }}"
                                pct: "{{ (elapsed / repeat.item.ramp|float) * repeat.item.target|float | round(1) }}"
                            - service: light.turn_on
                              target: { entity_id: "{{ repeat.item.entity }}" }
                              data: { brightness_pct: "{{ [pct, repeat.item.target]|min }}" }
                        - conditions: "{{ dim_ts <= now_ts <= dim_end }}"
                          sequence:
                            - variables:
                                elapsed_dim: "{{ (now_ts - dim_ts) / 60 }}"
                                pct: "{{ repeat.item.target|float - ((elapsed_dim / repeat.item.dim_ramp|float) * repeat.item.target|float) | round(1) }}"
                            - service: light.turn_on
                              target: { entity_id: "{{ repeat.item.entity }}" }
                              data: { brightness_pct: "{{ [pct, 0]|max }}" }
                        - conditions: "{{ now_ts < start_ts or now_ts > dim_end }}"
                          sequence:
                            - service: light.turn_off
                              target: { entity_id: "{{ repeat.item.entity }}" }

      # --- ğŸ½ï¸ Karmienie ---------------------------------------------
      - conditions: "{{ feed is not none and filter is not none }}"
        sequence:
          - choose:
              - conditions: "{{ trigger.entity_id == feed and is_state(feed, 'on') }}"
                sequence:
                  - service: switch.turn_off
                    target: { entity_id: "{{ filter }}" }
                  - service: timer.start
                    target: { entity_id: "{{ feed_timer }}" }
                    data: { duration: "{{ (feed_duration|int * 60)|int }}" }
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ½ï¸ RozpoczÄ™to karmienie"
                      message: "Filtr wyÅ‚Ä…czony na {{ feed_duration }} minut."
              - conditions: "{{ trigger.entity_id == feed and is_state(feed, 'off') }}"
                sequence:
                  - service: switch.turn_on
                    target: { entity_id: "{{ filter }}" }
                  - service: timer.cancel
                    target: { entity_id: "{{ feed_timer }}" }
              - conditions: "{{ trigger.event_type == 'timer.finished' }}"
                sequence:
                  - service: switch.turn_on
                    target: { entity_id: "{{ filter }}" }
                  - service: input_boolean.turn_off
                    target: { entity_id: "{{ feed }}" }
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ½ï¸ Karmienie zakoÅ„czone (timer)"
                      message: "Filtr ponownie wÅ‚Ä…czony po zakoÅ„czeniu odliczania."

      # --- ğŸ’¨ COâ‚‚ wg ramp (Â±1 min, korekcja stanu + po restarcie) ---
      - conditions: "{{ co2 is not none }}"
        sequence:
          - variables:
              start_times:
                - !input front_start_time
                - !input back_start_time
                - !input sun_start_time
                - !input grow_start_time
              dim_times:
                - !input front_dim_time
                - !input back_dim_time
                - !input sun_dim_time
                - !input grow_dim_time
              earliest_start: "{{ start_times | reject('equalto', None) | min }}"
              earliest_dim: "{{ dim_times | reject('equalto', None) | min }}"
              now_t: "{{ as_timestamp(now()) }}"
              start_t: "{{ as_timestamp(as_datetime(now().strftime('%Y-%m-%dT' ~ earliest_start))) }}"
              off_t: "{{ as_timestamp(as_datetime(now().strftime('%Y-%m-%dT' ~ earliest_dim)) - timedelta(minutes=30)) }}"
              should_be_on: "{{ now_t >= start_t and now_t < off_t }}"
              is_on: "{{ is_state(co2, 'on') }}"
          - choose:

              # --- WÅ‚Ä…czenie COâ‚‚ (okno Â±1 min + korekcja stanu + po starcie) ---
              - conditions: >
                  {{ trigger.platform in ['homeassistant','time_pattern'] and
                     ((now_t >= (start_t - 60) and now_t <= (start_t + 60)) or (should_be_on and not is_on)) }}
                sequence:
                  - service: switch.turn_on
                    target: { entity_id: "{{ co2 }}" }
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ’¨ COâ‚‚ wÅ‚Ä…czone"
                      message: >
                        COâ‚‚ aktywowane o {{ earliest_start }}.
                        (dokÅ‚adnoÅ›Ä‡ Â±1 minuty, korekcja stanu: {{ 'tak' if not is_on else 'nie' }})

              # --- WyÅ‚Ä…czenie COâ‚‚ (okno Â±1 min + korekcja stanu + po starcie) ---
              - conditions: >
                  {{ trigger.platform in ['homeassistant','time_pattern'] and
                     ((now_t >= (off_t - 60) and now_t <= (off_t + 60)) or (not should_be_on and is_on)) }}
                sequence:
                  - service: switch.turn_off
                    target: { entity_id: "{{ co2 }}" }
                  - service: persistent_notification.create
                    data:
                      title: "ğŸ’¨ COâ‚‚ wyÅ‚Ä…czone"
                      message: >
                        COâ‚‚ wyÅ‚Ä…czone 30 min przed Å›ciemnianiem ({{ earliest_dim }}).
                        (dokÅ‚adnoÅ›Ä‡ Â±1 minuty, korekcja stanu: {{ 'tak' if is_on else 'nie' }})


      # --- ğŸ©º Diagnostyka blueprintu ----------------------------------
      - conditions: []
        sequence:
          - service: persistent_notification.create
            data:
              title: "ğŸ©º Diagnostyka blueprintu Akwarium"
              message: |
                ğŸ’¡ KanaÅ‚y aktywne: {{ [lights.front, lights.back, lights.sun, lights.grow] | select('string') | list }}
                ğŸ’¨ COâ‚‚: {{ co2 if co2 else 'brak' }}
                ğŸ’§ Filtr: {{ filter if filter else 'brak' }}
                ğŸ½ï¸ Karmienie: {{ feed if feed else 'brak' }}
                â³ Timer karmienia: {{ feed_timer if feed_timer else 'brak' }}

# =====================================================================
# ğŸ§­ TODO â€“ PLAN ROZWOJU: WERSJA 2025.3 BETA (COâ‚‚ FIX RELEASE)
# =====================================================================
# Celem tej wersji jest zapewnienie 100% niezawodnej synchronizacji COâ‚‚
# z harmonogramem ramp â€“ rÃ³wnieÅ¼ po restarcie Home Assistant i reloadzie konfiguracji.
#
# ğŸ’¨ Zmiany planowane:
# ---------------------------------------------------------------------
# 1ï¸âƒ£ PodwÃ³jna weryfikacja po starcie HA:
#     - COâ‚‚ sprawdzane po 10 sekundach oraz ponownie po 60 sekundach.
#     - Gwarantowana korekta nawet przy wolnym starcie systemu.
#
# 2ï¸âƒ£ Analiza state.last_changed:
#     - JeÅ¼eli stan COâ‚‚ nie zmieniÅ‚ siÄ™ od czasu startu HA â†’ wymuszenie korekty.
#
# 3ï¸âƒ£ ObsÅ‚uga reload automatyzacji (automation_reloaded):
#     - Korekta COâ‚‚ uruchamiana rÃ³wnieÅ¼ po zwykÅ‚ym przeÅ‚adowaniu konfiguracji.
#
# 4ï¸âƒ£ Zintegrowana pÄ™tla ramp + COâ‚‚:
#     - Weryfikacja COâ‚‚ w tym samym przebiegu co rampy (time_pattern co minutÄ™).
#
# 5ï¸âƒ£ Tryb â€cichyâ€ (opcjonalny):
#     - Powiadomienia zastÄ…pione wpisami w logbook.
#
# 6ï¸âƒ£ Bezpieczny fallback:
#     - JeÅ›li nie moÅ¼na ustaliÄ‡ earliest_start / earliest_dim â†’ COâ‚‚ wyÅ‚Ä…czone awaryjnie.
#
# ğŸ§  Dodatkowe planowane usprawnienia:
#     - Lepsza odpornoÅ›Ä‡ na rÃ³Å¼nice czasu systemowego po restarcie.
#     - Tryb debug (input_boolean.aquarium_debug) z logami decyzji ramp i COâ‚‚.
#     - SpÃ³jne nazwy powiadomieÅ„ i logÃ³w.
#
# ğŸ“… Harmonogram:
#     ğŸ”¹ Specyfikacja: âœ… gotowa
#     ğŸ”¹ Implementacja 2025.3 BETA1: â³ do wykonania
#     ğŸ”¹ Testy w HA 2025.10.x: â³ planowane
#     ğŸ”¹ Wersja stabilna 2025.3 STABLE: ğŸ—“ï¸ po testach
#
# ğŸ“˜ Plik docelowy:
#     blueprints/automation/gieoerzet/akwarium_2025.3_beta1.yaml
# =====================================================================
